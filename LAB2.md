# Лабораторная работа №2: Продвинутые возможности API

## Обзор новых возможностей

В рамках второй лабораторной работы добавлены следующие возможности:

1. **Пагинация** - для всех списочных эндпоинтов
2. **Опциональные поля** - выборочная загрузка данных
3. **Внутренние API** - служебные эндпоинты для внутренних сервисов
4. **Расширенная безопасность** - двойная система аутентификации
5. **Улучшенные лимиты** - детальный rate limiting

Все изменения **обратно совместимы** с версией из Лабораторной №1.

---

## Пагинация

### Обоснование выбора метода

Реализована **offset-based пагинация** (page/page_size).

**Преимущества:**
- Простота реализации и использования
- Предсказуемость (легко перейти к любой странице)
- Понятность для пользователей (страница 1, 2, 3...)
- Хорошо работает с небольшими и средними наборами данных
- Поддержка SQL OFFSET/LIMIT из коробки

**Альтернативы и почему не выбраны:**

1. **Cursor-based пагинация**
   - Сложнее в реализации
   - Менее интуитивна для пользователей
   - Хороша для бесконечной прокрутки (не наш случай)

2. **Keyset пагинация**
   - Требует стабильную сортировку
   - Не позволяет переход к произвольной странице
   - Сложнее для клиентов

### Структура ответа

```json
{
  "items": [...],
  "total": 100,
  "page": 1,
  "page_size": 10,
  "total_pages": 10,
  "has_next": true,
  "has_prev": false
}
```

### Примеры использования

#### Получение первой страницы книг

```bash
curl -X GET "http://localhost:8000/api/v1/books?page=1&page_size=10" \
  -H "Authorization: Bearer $TOKEN"
```

#### Получение второй страницы с размером 20

```bash
curl -X GET "http://localhost:8000/api/v2/books?page=2&page_size=20" \
  -H "Authorization: Bearer $TOKEN"
```

#### Получение авторов с пагинацией

```bash
curl -X GET "http://localhost:8000/api/v2/authors?page=1&page_size=5" \
  -H "Authorization: Bearer $TOKEN"
```

### Параметры пагинации

| Параметр | Тип | По умолчанию | Ограничения | Описание |
|----------|-----|--------------|-------------|----------|
| page | integer | 1 | >= 1 | Номер страницы |
| page_size | integer | 10 | 1-100 | Размер страницы |

**Ограничение page_size:**
- Минимум: 1
- Максимум: 100
- **Обоснование**: Предотвращает перегрузку сервера и клиента большими объемами данных

---

## Опциональные поля

### Концепция

Клиенты могут запрашивать только нужные им поля, экономя трафик и время обработки.

### Реализованные опции

#### 1. Параметр `fields`

Позволяет выбрать конкретные поля через запятую.

**Пример запроса:**
```bash
curl -X GET "http://localhost:8000/api/v1/books/1?fields=id,title,year" \
  -H "Authorization: Bearer $TOKEN"
```

**Ответ:**
```json
{
  "id": 1,
  "title": "Война и мир",
  "year": 1869
}
```

**Без параметра fields (полный ответ):**
```json
{
  "id": 1,
  "title": "Война и мир",
  "author": "Лев Толстой",
  "year": 1869,
  "isbn": "978-5-17-098229-4",
  "created_at": "2025-10-14T10:30:00"
}
```

#### 2. Параметр `include_author` (только V2)

Для книг V2 можно включить детальную информацию об авторе.

**Пример запроса:**
```bash
curl -X GET "http://localhost:8000/api/v2/books/1?include_author=true" \
  -H "Authorization: Bearer $TOKEN"
```

**Ответ с include_author=true:**
```json
{
  "id": 1,
  "title": "Война и мир",
  "author_id": 1,
  "year": 1869,
  "isbn": "978-5-17-098230-0",
  "pages": 1274,
  "genre": "Исторический роман",
  "created_at": "2025-10-14T10:30:00",
  "updated_at": null,
  "author": {
    "id": 1,
    "name": "Лев Николаевич Толстой"
  }
}
```

**Ответ с include_author=false (по умолчанию):**
```json
{
  "id": 1,
  "title": "Война и мир",
  "author_id": 1,
  "year": 1869,
  "isbn": "978-5-17-098230-0",
  "pages": 1274,
  "genre": "Исторический роман",
  "created_at": "2025-10-14T10:30:00",
  "updated_at": null
}
```

### Комбинирование параметров

Можно комбинировать пагинацию, фильтрацию и опциональные поля:

```bash
curl -X GET "http://localhost:8000/api/v2/books?page=1&page_size=5&genre=Фантастика&fields=id,title,pages&include_author=true" \
  -H "Authorization: Bearer $TOKEN"
```

### Обоснование реализации

**Какие поля сделаны опциональными и почему:**

1. **Все поля через `fields`**
   - Клиент может загрузить только ID и название для списков
   - Экономия трафика на мобильных устройствах
   - Ускорение загрузки больших списков

2. **author (через `include_author`)**
   - Дополнительный JOIN запрос к БД
   - Не всегда нужна детальная информация об авторе
   - Позволяет избежать N+1 проблемы

**Преимущества:**
- Снижение нагрузки на сеть
- Уменьшение времени ответа
- Гибкость для клиентов
- Оптимизация мобильного трафика

---

## Внутренние API

### Концепция

Отдельные эндпоинты для внутренних сервисов с упрощенной авторизацией и расширенными возможностями.

### Аутентификация внутреннего API

Используется **API Key** вместо JWT.

**Заголовок:** `X-Internal-API-Key`

**Пример:**
```bash
curl -X GET "http://localhost:8000/internal/statistics" \
  -H "X-Internal-API-Key: internal-secret-key-12345"
```

**Обоснование выбора API Key для внутреннего API:**
- Простота (не нужно обновлять токены)
- Подходит для server-to-server коммуникации
- Меньше накладных расходов
- Не требует пользовательской сессии

### Реализованные внутренние эндпоинты

#### 1. Массовое удаление книг

**POST** `/internal/books/v2/bulk-delete`

**Почему внутренний:**
- Потенциально опасная операция
- Не требует детальной валидации
- Используется для очистки данных
- Упрощенная авторизация

**Упрощения:**
- Нет проверки прав конкретного пользователя
- Нет подробного логирования
- Не создает резервные копии
- Не проверяет зависимости

**Пример запроса:**
```bash
curl -X POST "http://localhost:8000/internal/books/v2/bulk-delete" \
  -H "X-Internal-API-Key: internal-secret-key-12345" \
  -H "Content-Type: application/json" \
  -d '{
    "ids": [10, 11, 12, 13]
  }'
```

**Ответ:**
```json
{
  "deleted_count": 3,
  "failed_ids": [13]
}
```

#### 2. Статистика системы

**GET** `/internal/statistics`

**Почему внутренний:**
- Содержит агрегированные данные
- Может быть ресурсоемким
- Для дашбордов и аналитики
- Не требует пользовательской аутентификации

**Пример запроса:**
```bash
curl -X GET "http://localhost:8000/internal/statistics" \
  -H "X-Internal-API-Key: internal-secret-key-12345"
```

**Ответ:**
```json
{
  "total_books_v1": 5,
  "total_books_v2": 12,
  "total_authors": 8,
  "total_users": 1,
  "genres": [
    {"genre": "Фантастика", "count": 3},
    {"genre": "Роман", "count": 4},
    {"genre": "Исторический роман", "count": 2}
  ],
  "books_by_year": [
    {"year": 2024, "count": 1},
    {"year": 1997, "count": 1},
    {"year": 1967, "count": 2}
  ]
}
```

#### 3. Детальная проверка здоровья

**GET** `/internal/health/detailed`

**Почему внутренний:**
- Детальная информация о системе
- Может раскрывать внутреннюю архитектуру
- Для мониторинга и алертинга

**Пример запроса:**
```bash
curl -X GET "http://localhost:8000/internal/health/detailed" \
  -H "X-Internal-API-Key: internal-secret-key-12345"
```

**Ответ:**
```json
{
  "status": "healthy",
  "timestamp": "2025-10-14T12:30:00",
  "database": "connected",
  "versions": ["v1", "v2"],
  "uptime": "2:15:30",
  "rate_limit_records": 245,
  "idempotency_records": 18
}
```

#### 4. Очистка старых записей

**DELETE** `/internal/cleanup/old-records`

**Почему внутренний:**
- Техническая операция обслуживания
- Не связана с бизнес-логикой
- Может влиять на производительность

**Пример запроса:**
```bash
curl -X DELETE "http://localhost:8000/internal/cleanup/old-records?days=7" \
  -H "X-Internal-API-Key: internal-secret-key-12345"
```

**Ответ:**
```json
{
  "message": "Cleanup completed",
  "rate_limit_deleted": 1245,
  "idempotency_deleted": 56,
  "older_than_days": 7
}
```

### Безопасность внутреннего API

**Рекомендации для production:**
1. Использовать сложный API ключ (256 бит)
2. Ротация ключей каждые 90 дней
3. Белый список IP адресов
4. Логирование всех запросов
5. Rate limiting для внутреннего API
6. Использование VPN или private network

---

## Расширенная безопасность

### Двухуровневая система аутентификации

1. **JWT для публичного API** (пользователи)
   - Срок действия: 30 минут
   - Содержит информацию о пользователе
   - Требует периодического обновления

2. **API Key для внутреннего API** (сервисы)
   - Долгоживущий ключ
   - Простая проверка
   - Server-to-server аутентификация

### Rate Limiting

Сохраняется из Лабораторной №1:
- 10 запросов в минуту на IP
- Заголовки: `X-Limit-Remaining`, `Retry-After`
- Хранение в PostgreSQL

**Исключение:** Internal API не подлежит rate limiting (проверяется middleware).

---

## Примеры полных сценариев

### Сценарий 1: Получение списка книг с минимальным трафиком

```bash
# Только ID и названия, первая страница
curl -X GET "http://localhost:8000/api/v2/books?page=1&page_size=20&fields=id,title" \
  -H "Authorization: Bearer $TOKEN"
```

### Сценарий 2: Детальный просмотр книги с автором

```bash
# Полная информация включая автора
curl -X GET "http://localhost:8000/api/v2/books/1?include_author=true" \
  -H "Authorization: Bearer $TOKEN"
```

### Сценарий 3: Фильтрация с опциональными полями

```bash
# Фантастические книги, только основная информация
curl -X GET "http://localhost:8000/api/v2/books?genre=Фантастика&fields=id,title,year,pages" \
  -H "Authorization: Bearer $TOKEN"
```

### Сценарий 4: Массовая очистка (внутренний сервис)

```bash
# Удаление тестовых данных
curl -X POST "http://localhost:8000/internal/books/v2/bulk-delete" \
  -H "X-Internal-API-Key: internal-secret-key-12345" \
  -H "Content-Type: application/json" \
  -d '{"ids": [100, 101, 102, 103, 104]}'
```

### Сценарий 5: Мониторинг системы

```bash
# Получение статистики для дашборда
curl -X GET "http://localhost:8000/internal/statistics" \
  -H "X-Internal-API-Key: internal-secret-key-12345"
```

---

## Обратная совместимость

Все изменения полностью обратно совместимы:

- **V1 API** - без изменений в поведении по умолчанию
- **V2 API** - новые параметры опциональны
- **Старые клиенты** - продолжают работать без модификаций
- **Пагинация** - параметры по умолчанию (page=1, page_size=10)
- **Опциональные поля** - по умолчанию возвращаются все поля

**Пример:** Запрос без новых параметров работает как раньше
```bash
# Работает как в Lab 1
curl -X GET "http://localhost:8000/api/v1/books" \
  -H "Authorization: Bearer $TOKEN"
```

---

## Сравнительная таблица возможностей

| Возможность | Lab 1 | Lab 2 | Обоснование |
|-------------|-------|-------|-------------|
| Пагинация | ❌ | ✅ | Масштабирование для больших данных |
| Опциональные поля | ❌ | ✅ | Оптимизация трафика |
| Внутренний API | ❌ | ✅ | Служебные операции |
| JWT Auth | ✅ | ✅ | Безопасность для пользователей |
| API Key Auth | ❌ | ✅ | Простота для сервисов |
| Rate Limiting | ✅ | ✅ | Защита от перегрузки |
| Идемпотентность | ✅ | ✅ | Надежность операций |
| Версионирование | ✅ | ✅ | Поддержка миграций |

---

## Выводы

### Достижения Lab 2

1. Реализована эффективная пагинация
2. Добавлена гибкость через опциональные поля
3. Создан внутренний API для служебных задач
4. Расширена система безопасности
5. Сохранена полная обратная совместимость
